<script>
(function(){
  // DOM 참조
  const code1    = document.getElementById('code1'),
        code2    = document.getElementById('code2'),
        value1   = document.getElementById('value1'),
        value2   = document.getElementById('value2'),
        rateTime = document.getElementById('rateTime'),
        swapTop  = document.getElementById('swapBtn'),
        keypad   = document.querySelector('.keypad');

  let inputStr = '';

  function updateDisplay() {
    value1.innerText = inputStr || '0';
  }

  async function fetchAndConvert() {
    // 1) 계산값 안전 파싱
    let amt = 0;
    try {
      // 간단히 eval 대신 Function 사용
      amt = Function('"use strict";return('+ (inputStr||'0') +')')();
      if (isNaN(amt)) amt = 0;
    } catch {
      amt = 0;
    }

    // 2) 현재 위/아래 통화코드
    const fromCur = code1.innerText;
    const toCur   = code2.innerText;

    try {
      // Frankfurter 무료 CORS API 사용
      const res  = await fetch(`https://api.frankfurter.app/latest?from=${fromCur}&to=${toCur}`);
      if (!res.ok) throw new Error(res.status);

      const json = await res.json();
      const rate = json.rates?.[toCur];
      if (typeof rate !== 'number') throw new Error('환율 데이터 이상');

      // 3) 환산 & 화면 갱신
      const converted = Math.round(amt * rate);
      value2.innerText   = converted.toLocaleString();
      rateTime.innerText = '조회 시간: ' + new Date(json.date).toLocaleString();

    } catch (e) {
      alert('환율 정보를 가져오는 데 실패했어요.\n오류: ' + e.message);
    }
  }

  // 패널 스왑
  function swapPanels() {
    const f1 = document.getElementById('flag1'),
          f2 = document.getElementById('flag2'),
          c1 = document.getElementById('code1'),
          c2 = document.getElementById('code2');

    // 이모지/코드/값 서로 교체
    [f1.innerText, f2.innerText] = [f2.innerText, f1.innerText];
    [c1.innerText, c2.innerText] = [c2.innerText, c1.innerText];
    [value1.innerText, value2.innerText] = [value2.innerText, value1.innerText];

    inputStr = '';
    updateDisplay();
    rateTime.innerText = '조회 시간: --';
  }

  // 키패드 클릭 처리
  keypad.addEventListener('click', e => {
    if (e.target.tagName !== 'BUTTON') return;
    const action = e.target.dataset.action;
    const key    = e.target.dataset.key;

    switch(action) {
      case 'clear':
        inputStr = '';
        updateDisplay();
        value2.innerText = '0';
        rateTime.innerText = '조회 시간: --';
        break;
      case 'back':
        inputStr = inputStr.slice(0,-1);
        updateDisplay();
        break;
      case 'swap':
        swapPanels();
        break;
      case 'divide': case 'multiply': case 'minus': case 'plus':
        inputStr += e.target.textContent;
        updateDisplay();
        break;
      case 'decimal':
        if (!inputStr.includes('.')) inputStr += '.';
        updateDisplay();
        break;
      case 'equal':
        fetchAndConvert();
        break;
      default:
        if (key) {
          inputStr += key;
          updateDisplay();
        }
    }
  });

  // 상단 스왑 버튼
  swapTop.addEventListener('click', swapPanels);

  // 초기화
  updateDisplay();
})();
</script>
