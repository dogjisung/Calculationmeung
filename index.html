<script>
(function(){
  const WORKER_PROXY_URL = 'https://broad-breeze-4af6.jane785714.workers.dev?url=';
  const API_URL = 'https://api.exchangerate.host/latest?base=USD&symbols=KRW';

  let inputStr = '';

  function updateDisplay(){
    document.getElementById('usdValue').innerText = inputStr || '0';
  }

  async function fetchAndConvert(){
    try {
      // ① Worker 프록시 + 캐시 버스터
      const proxyUrl = WORKER_PROXY_URL + encodeURIComponent(API_URL + '&_=' + Date.now());
      console.log('▶️ 프록시 호출 URL:', proxyUrl);

      const res = await fetch(proxyUrl);
      if (!res.ok) throw new Error('HTTP ' + res.status);

      // 디버깅 로그: 진짜 응답이 뭐 오는지 확인
      const raw = await res.clone().text();
      console.log('▶️ API 응답(raw):', raw);

      const json = JSON.parse(raw);
      if (!json.rates || typeof json.rates.KRW !== 'number') {
        throw new Error('API 형식이 올바르지 않습니다');
      }

      const rate = json.rates.KRW;
      const result = eval(inputStr) * rate;
      document.getElementById('krwValue').innerText = Math.round(result).toLocaleString();
      document.getElementById('rateTime').innerText = '기준: ' + new Date().toLocaleString();

    } catch (e) {
      alert(
        '환율 정보를 가져오는 데 실패했어요.\n' +
        '오류: ' + e.message + '\n' +
        '인터넷 연결을 확인하거나 잠시 후 다시 시도해주세요.'
      );
    }
  }

  document.querySelector('.keypad').addEventListener('click', e => {
    if (e.target.tagName !== 'BUTTON') return;
    const action = e.target.dataset.action;
    const key    = e.target.dataset.key;

    if (action === 'clear')      { inputStr = ''; updateDisplay(); return; }
    if (action === 'back')       { inputStr = inputStr.slice(0,-1); updateDisplay(); return; }
    if (action === 'decimal')    { inputStr += '.'; updateDisplay(); return; }
    if (/^(divide|multiply|minus|plus)$/.test(action)) {
      inputStr += ' ' + e.target.textContent + ' ';
      updateDisplay(); return;
    }
    if (key) {
      inputStr += key; updateDisplay(); return;
    }
    if (action === 'equal') {
      fetchAndConvert();
    }
  });
})();
</script>